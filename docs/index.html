<!doctype html>
<html lang="fr">
    <head>
        <title>Liste HFR Steam</title>
        <script src="hfr.js" type="text/javascript"></script>
        <script src="jquery/js/jquery-3.3.1.min.js" type="text/javascript"></script>
        <script src="popper/popper.min.js" type="text/javascript"></script>
        <script src="bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
        <script src="watable/js/jquery.watable.js" type="text/javascript"></script>
        <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
        <link href="watable/css/watable.css" rel="stylesheet" type="text/css"/>
        <link href="fontawesome/css/all.min.css" rel="stylesheet" type="text/css"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <meta name="Description" content="Liste HFR Steam"/>
        <style type="text/css">
            /* For Watable */
            .watable input[type=text].filter {
                font-style: italic;
                font-weight: bold;
                width: 100%;
            }
            .table th {
                padding: 0.25em;
            }
            .table td{
                padding: 0.5em;
            }
            /* For Watable */

            /* For Watable and Bootstrap v4*/
            .pagination>.active>a, .pagination>.active>a:focus, .pagination>.active>a:hover, .pagination>.active>span, .pagination>.active>span:focus, .pagination>.active>span:hove {
                z-index: 3;
                color: #337ab7;
                cursor: default;
                background-color: #337ab7;
                border-color: #337ab7;
            }
            .pagination>li>a {
                position: relative;
                float: left;
                padding: 4px 12px;
                margin-bottom: 0.5em;
                line-height: 1.42857143;
                color: #337ab7;
                text-decoration: none;
                background-color: #fff;
                border: 1px solid #ddd;
            }
            .pagination>li>a:hover {
                color: #333;
                background-color: #e6e6e6;
                border-color: #adadad;
            }
            .pagination>.active>a, .pagination>.active>a:focus, .pagination>.active>a:hover, .pagination>.active>span, .pagination>.active>span:focus, .pagination>.active>span:hover {
                z-index: 3;
                color: #fff;
                cursor: default;
                background-color: #337ab7;
                border-color: #337ab7;
            }
            .pagination>li>a:focus, .pagination>li>a:hover, .pagination>li>span:focus, .pagination>li>span:hover {
                z-index: 2;
                color: #23527c;
                background-color: #eee;
                border-color: #ddd;
            }
            .pagination>.disabled>a, .pagination>.disabled>a:focus, .pagination>.disabled>a:hover, .pagination>.disabled>span, .pagination>.disabled>span:focus, .pagination>.disabled>span:hover {
                color: #777;
                cursor: not-allowed;
                background-color: #fff;
                border-color: #ddd;
            }
            .btn-default {
                color: #333;
                padding: 4px 12px;
                background-color: #fff;
                border-color: #ccc;
                height: 26.6154px;
                line-height: 17.1429px;
                margin-left: 0.5em;
                margin-bottom: 0.5em;
            }
            .btn-default:focus, .btn-default:hover {
                color: #333;
                background-color: #e6e6e6;
                border-color: #adadad;
            }
            .dropdown-menu>li>a {
                display: block;
                padding: 3px 20px;
                clear: both;
                font-weight: 400;
                line-height: 1.42857143;
                color: #333;
                white-space: nowrap;
            }
            .dropdown-menu>li>a:focus, .dropdown-menu>li>a:hover {
                color: #262626;
                text-decoration: none;
                background-color: #f5f5f5;
            }
            .pull-right {
                float: right!important;
            }
            /* For Watable and Bootstrap v4*/

            /* Simple styling */
            h1 {
                font-size: 2em;
                margin-top: 0.5em;
                margin-bottom: 0em;
            }
            h6 {
                font-size: 0.6em;
                margin-top: 0em;
                margin-left: 0.2em;
            }
            .main {
                margin-top: 0em;
                margin-bottom: 0em;
                margin-left: 0.4em;
                margin-right: 0em;
            }
            form {
                font-size: 0.7em;
            }
            .override {
                font-style: italic;
                color: Green;
                font-size: xx-small;
            }
            .text {
                white-space: pre-line;
                text-align: justify;
                text-justify: inter-word;
                line-height: 150%;
            }
            /* Simple styling */

            /* For the fancy checkbox */
            .badge {
                color: #17a2b8;
                background-color: white;
            }
            /* Hiding the checkbox, but allowing it to be focused */
            .badgebox {
                opacity: 0;
            }
            .badgebox + .badge {
                /* Move the check mark away when unchecked */
                text-indent: -999999px;
                /* Makes the badge's width stay the same checked and unchecked */
                width: 27px;
            }
            .badgebox:checked + .badge {
                /* Move the check mark back when checked */
                text-indent: 0;
            }
            /* For the fancy checkbox */
        </style>
    </head>
    <body>
        <div class="main">
            <div id="headers">
                <h1>Liste HFR Steam</h1>
                <h6>Mise à jour le $D$
                </h6>
                <a href="https://github.com/John-Gee/HFRSteam" target="_blank" rel="noopener">
                    <img style="position: absolute; top: 0; right: 0; border: 0; max-width: 75px;" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"/>
                </a>

                <form action="#" onsubmit="return false">
                    <a data-toggle="tooltip" title="URL du profil, ex: https://steamcommunity.com/id/geeHFR ou simplement le nom, ex: geeHFR">
                        <input type="text" name="library" id="libraryId" placeholder="Votre profil Steam" size="25"/>
                    </a>

                    <button type="button" id="myButton">Charger le profile Steam <span id="spinner"></span></button>
                </form>
            </div>
            <div id="wata" style="width:auto"></div>
            <div id="option">
                <label for="bigImages" class="btn btn-info btn-sm">Images HQ<input type="checkbox" id="bigImages" class="badgebox"/><span class="badge">&check;</span></label>
            </div>
            <div id="rules">
                <a href="https://forum.hardware.fr/hfr/JeuxVideo/Achat-Ventes/gratuit-origin-download-sujet_171605_1.htm#t8945000" style="color:grey" target="_blank" rel="noopener"><small>&nbsp;*<u>Règles pour la liste standard et ses nouveautées (vers le haut du poste).</u></small></a>
                <br/>
                <a href="https://forum.hardware.fr/hfr/JeuxVideo/Achat-Ventes/gratuit-origin-download-sujet_171605_1.htm#t8952242" style="color:grey" target="_blank" rel="noopener"><small>**<u>Règles pour les listes donateur et premium (vers le milieu du poste).</u></small></a>
                <br/>
            </div>
            <div class="override">
                Prière de faire attention, ces liens ne pointant pas directement vers l'énonciation des règles.
            </div>
            <script type="text/javascript">
                $(document).ready(function(){
                    if (localStorage.getItem('bigImages') == 'true') {
                        $('#bigImages').prop('checked', true);
                        $('#bigImages').trigger('change');
                    }

                    $('#headers').html($('#headers').html().replace('$D$', getDate()));

                    jQuery("a").filter(function() {
                        return this.hostname != window.location.hostname;
                    }).attr('rel', 'noopener').attr('target', '_blank');

                    $('#libraryId').keypress(function(e){
                        if (e.keyCode==13) {
                            $('#myButton').click();
                        }
                    });

                    function ProxyURL(url) {
                        return 'https://cors-anywhere.herokuapp.com/' + url;
                    }

                    function SpinSpinner() {
                        RemoveSpinner();
                        $('#spinner').addClass('fas fa-sync fa-spin fa-1x fa-fw');
                    }

                    function StopSpinner() {
                        $('#spinner').removeClass('fa-spin');
                    }

                    function RemoveSpinner() {
                        $('#spinner').removeClass();
                    }

                    function ColorSpinner(color) {
                        $('#spinner').css('color', color);
                    }

                    function ProfileError(error){
                        StopSpinner();
                        ColorSpinner('red');
                        UpdateTable({}, {});
                        alert(error);
                    }

                    function UpdateTable(libraryURLs, wishlistURLs) {
                        var data = waTable.getData();
                        // change the rows
                        for (i = 0; i < data.rows.length; ++i) {
                            if (data.rows[i]['nameFormat']) {
                                var href = data.rows[i]['nameFormat'];
                                href = href.substring(href.indexOf('"') + 1);
                                href = href.substring(0, href.indexOf('"'));
                                cls  = data.rows[i]['row-cls'];

                                if (href in libraryURLs) {
                                    data.rows[i]['row-cls'] = 'green,';
                                    data.rows[i]['store'] = 'Librarie';
                                }

                                else if (href in wishlistURLs) {
                                    data.rows[i]['row-cls'] = 'blue,';
                                    data.rows[i]['store'] = 'Souhait';
                                }

                                else {
                                    data.rows[i]['row-cls'] = '';
                                    data.rows[i]['store'] = '';
                                }

                                if ((typeof cls !== 'undefined') && (cls.includes('override')))
                                    data.rows[i]['row-cls'] += 'override,'
                            }
                        }
                        Platform.performMicrotaskCheckpoint();
                        waTable.setData(data);
                        StopSpinner();
                    }

                    $('#myButton').click(function(){
                        SpinSpinner();
                        ColorSpinner('Orange');
                        var profile = $.trim(document.getElementById('libraryId').value);
                        if (!profile || /^\s*$/.test(profile)) {
                            ProfileError('Aucun profile!');
                            return;
                        }
                        if (profile.startsWith('http'))
                            profile = profile.replace('http:', 'https:');
                        else
                            if (profile.indexOf('/') == -1)
                                profile = 'https://steamcommunity.com/id/' + profile
                            else
                                profile = 'https://' + profile;
                        profile = profile.toLowerCase();

                        //profile
                        var profileURL = ProxyURL(profile);
                        $.get(profileURL, function(page) {
                            var gamesURL = profile + '/games/?tab=all';
                            // Verify that the profile exists and is public
                            var profileerror = 'The specified profile could not be found.';
                            if (page.includes(profileerror)) {
                                ProfileError('Le profil n\'existe pas!');
                                return;
                            } else if (!page.toLowerCase().includes(gamesURL)) {
                                ProfileError('Le profil n\'est pas public!');
                                return;
                            }

                            // library
                            var library = ProxyURL(gamesURL);
                            $.get(library, function(page) {
                                ColorSpinner('Yellow');
                                var divclass = '<div class=\"profile_small_header_bg\">';
                                var beginning = 'var rgGames = ';
                                var subpage = page.substring(page.indexOf(divclass));
                                subpage = subpage.substring(subpage.indexOf(beginning) + beginning.length);
                                subpage = subpage.substring(0, subpage.indexOf('];') + 1);
                                try {
                                    var libraryURLs = {};
                                    var games = jQuery.parseJSON(subpage);
                                    var i;
                                    var GAMEURL = 'https://store.steampowered.com/app/';
                                    for (i = 0 ; i < games.length; ++i) {
                                        libraryURLs[GAMEURL + games[i].appid] = true;
                                    }
                                }
                                catch (e) {
                                    ProfileError(e.message);
                                }

                                // wishlist
                                var wishlist = ProxyURL(profile.replace('steamcommunity.com/id', 'store.steampowered.com/wishlist/id'));
                                $.get(wishlist, function(page) {
                                    ColorSpinner('Olive');
                                    var subpage = page.substring(page.indexOf('g_rgWishlistData') + 19);
                                    subpage     = subpage.substring(0, subpage.indexOf('g_rgAppInfo') - 8);
                                    try {
                                        var games = jQuery.parseJSON(subpage);
                                        var wishlistURLs = {};
                                        var i;
                                        var GAMEURL = 'https://store.steampowered.com/app/';
                                        for (x in games) {
                                            wishlistURLs[GAMEURL + x] = true;
                                        }

                                        UpdateTable(libraryURLs, wishlistURLs);
                                        ColorSpinner('Green');
                                    }
                                    catch (e) {
                                        ProfileError(e.message);
                                    }
                                });
                            });
                        });
                    });
                });

                var waTable = $('#wata').WATable({
                    debug: false,
                    databind: true,
                    filter: true,
                    sorting: true,
                    sortEmptyLast: true,
                    columnPicker: true,
                    pageSize: $.isNumeric(localStorage.getItem('pageSize')) ? localStorage.getItem('pageSize') : 10,
                    hidePagerOnEmpty: true,
                    types: {
                        string: {
                            placeHolder: 'filtre'
                        },
                    },
                    data: getData(),
                }).data('WATable');

                function getData() {
                    var cols = {
                        name: {
                            index: 1,
                            type: 'string',
                            friendly: 'Nom',
                            format: '<div class="text">{0}</div>',
                            unique: true,
                            sortOrder: 'asc',
                            filter: '',
                            hidden: localStorage.getItem('Nom') ? !('true' == localStorage.getItem('Nom')) : false,
                        },
                        description: {
                            index: 2,
                            type: 'string',
                            friendly: 'Description',
                            format: '<div class="text" style="text-indent:1em">{0}</div>',
                            unique: true,
                            filter: '',
                            sorting: false,
                            hidden: localStorage.getItem('Description') ? !('true' == localStorage.getItem('Description')) : false,
                        },
                        category: {
                            index: 3,
                            type: 'string',
                            friendly: 'Type',
                            unique: false,
                            filter: '',
                            hidden: localStorage.getItem('Type') ? !('true' == localStorage.getItem('Type')) : false,
                        },
                        os: {
                            index: 4,
                            type: 'string',
                            friendly: 'OS',
                            format: '<div class="text">{0}</div>',
                            unique: false,
                            filter: '',
                            hidden: localStorage.getItem('OS') ? !('true' == localStorage.getItem('OS')) : false,
                        },
                        price: {
                            index: 5,
                            type: 'number',
                            decimals: 2,
                            friendly: 'Prix',
                            unique: false,
                            filter: '',
                            hidden: localStorage.getItem('Prix') ? !('true' == localStorage.getItem('Prix')) : true,
                        },
                        genres: {
                            index: 6,
                            type: 'string',
                            friendly: 'Genres',
                            format: '<div class="text">{0}</div>',
                            unique: false,
                            filter: '',
                            hidden: localStorage.getItem('Genres') ? !('true' == localStorage.getItem('Genres')) : false,
                        },
                        date: {
                            index: 7,
                            type: 'string',
                            friendly: 'Parution',
                            unique: false,
                            filter: '',
                            hidden: localStorage.getItem('Parution') ? !('true' == localStorage.getItem('Parution')) : true,
                        },
                        review: {
                            index: 8,
                            type: 'string',
                            friendly: 'Revues',
                            format: '<div class="text">{0}</div>',
                            unique: false,
                            filter: '',
                            hidden: localStorage.getItem('Revues') ? !('true' == localStorage.getItem('Revues')) : false,
                        },
                        requirements: {
                            index: 9,
                            type: 'string',
                            friendly: 'Liste HFR',
                            format: '<div class="text">{0}</div>',
                            unique: false,
                            filter: '',
                            hidden: localStorage.getItem('Liste HFR') ? !('true' == localStorage.getItem('Liste HFR')) : false,
                        },
                        store: {
                            index: 10,
                            type: 'string',
                            friendly: 'Liste Steam',
                            unique: false,
                            filter: '',
                            hidden: localStorage.getItem('Liste Steam') ? !('true' == localStorage.getItem('Liste Steam')) : true,
                        },
                        interface: {
                            index: 11,
                            type: 'string',
                            friendly: 'Interface',
                            format: '<div class="text">{0}</div>',
                            unique: false,
                            filter: '',
                            hidden: localStorage.getItem('Interface') ? !('true' == localStorage.getItem('Interface')) : true,
                        },
                        audio: {
                            index: 12,
                            type: 'string',
                            friendly: 'Audio',
                            format: '<div class="text">{0}</div>',
                            unique: false,
                            filter: '',
                            hidden: localStorage.getItem('Audio') ? !('true' == localStorage.getItem('Audio')) : true,
                        },
                        subtitles: {
                            index: 13,
                            type: 'string',
                            friendly: 'Sous-Titres',
                            format: '<div class="text">{0}</div>',
                            unique: false,
                            filter: '',
                            hidden: localStorage.getItem('Sous-Titres') ? !('true' == localStorage.getItem('Sous-Titres')) : true,
                        },
                        wine: {
                            index: 14,
                            type: 'string',
                            friendly: 'Wine',
                            format: '<div class="text">{0}</div>',
                            unique: false,
                            filter: '',
                            hidden: localStorage.getItem('Wine') ? !('true' == localStorage.getItem('Wine')) : true,
                        },
                        tags: {
                            index: 100,
                            type: 'string',
                            friendly: 'Tags',
                            format: '<div class="text">{0}</div>',
                            unique: false,
                            filter: '',
                            hidden: localStorage.getItem('Tags') ? !('true' == localStorage.getItem('Tags')) : true,
                        },
                        details: {
                            index: 101,
                            type: 'string',
                            friendly: 'Details',
                            format: '<div class="text">{0}</div>',
                            unique: false,
                            filter: '',
                            hidden: localStorage.getItem('Details') ? !('true' == localStorage.getItem('Details')) : true,
                        },
                        giftdate: {
                            index: 102,
                            type: 'string',
                            friendly: 'Ajouté le',
                            unique: false,
                            filter: '',
                            hidden: localStorage.getItem('Ajouté le') ? !('true' == localStorage.getItem('Ajouté le')) : true,
                        },
                    };

                    var data = {
                        cols: cols,
                        rows: getRows(),
                    };

                    return data;
                }
                $(document).on('click', 'a', '.btn-group.dropup.pagesize', function(e){
                    var val = $(this).text().toLowerCase();
                    localStorage.setItem("pageSize", val);
                });
                $(document).on('hidden.bs.dropdown', '.btn-group.dropup.columnpicker', function(e){
                    var elem = $(this);
                    var ul = elem[0].childNodes[1];
                    var items = ul.getElementsByTagName("li");
                    for (var i = 0; i < items.length; ++i) {
                        name = items[i].textContent.trim();
                        checked = items[i].getElementsByTagName('input')[0].checked;
                        localStorage.setItem(name, checked);
                    }
                });
                $('#bigImages').change(function() {
                    var checked = this.checked;
                    localStorage.setItem('bigImages', checked);
                    $('img').each(function () {
                        var curSrc = $(this).attr('src');
                        if (checked)
                            var newSrc = curSrc.replace('capsule_sm_120.jpg', 'header.jpg');
                        else
                            var newSrc = curSrc.replace('header.jpg', 'capsule_sm_120.jpg');
                        $(this).attr('src', newSrc);
                    });
                });
            </script>
        </div>
        <script src="https://www.w3counter.com/tracker.js?id=112904"  type="text/javascript"></script>
    </body>
</html>
